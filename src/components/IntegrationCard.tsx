import type { Integration } from "@/app/data/integrations"
import { Card, CardContent } from "@/components/ui/card"
import { MessageSquare, Clock, Star, LucideIcon, Trash2 } from "lucide-react"
import Link from "next/link"
import { formatDistanceToNow } from "date-fns"
import { ko } from "date-fns/locale"
import { ChatSession } from "@/types"
import { useState } from "react"
import { useAuth } from "@/contexts/AuthContext"
import { getSupabaseClient } from "@/lib/supabase"
import { Dialog, DialogContent, DialogHeader, DialogFooter, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';

type IntegrationCardProps = {
  integration: Integration & { url?: string; chatSession?: Partial<ChatSession> }
  categoryCount?: number
  onFavoriteToggle?: () => void
  onDeleteSuccess?: (sessionId: string) => void
  userMap?: Record<string, string>
}

// Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉâÏÉÅ Îß§Ìïë
const categoryColors: Record<string, string> = {
  "Í∞úÎ∞ú": "#3b82f6", // blue-500
  "Ï∞ΩÏûë": "#ec4899", // pink-500
  "ÌïôÏäµ": "#8b5cf6", // violet-500
  "ÏóÖÎ¨¥": "#10b981", // emerald-500
  "Ï∑®ÎØ∏": "#f59e0b", // amber-500
  "ÏÉùÌôú": "#6366f1", // indigo-500
  "Í±¥Í∞ï": "#ef4444", // red-500
  "Í∏∞ÌÉÄ": "#64748b", // slate-500
  "Ïó¨Ìñâ": "#0ea5e9", // sky-500
  "Í∏∞Ïà†": "#a855f7", // purple-500
  "Í≤ΩÏ†ú": "#f97316", // orange-500
  "Analytics": "#3b82f6",
  "Marketing": "#ec4899",
  "Productivity": "#8b5cf6",
  "Sales": "#10b981",
  "Finance": "#f59e0b",
  "Communication": "#6366f1",
  "Cloud Services": "#ef4444",
  "Security": "#64748b",
  "Design": "#a855f7",
  "Development": "#06b6d4",
  "Human Resources": "#84cc16",
  "Customer Support": "#14b8a6",
  "E-commerce": "#f43f5e",
  "Social Media": "#8b5cf6"
}

export default function IntegrationCard({ integration, categoryCount, onFavoriteToggle, onDeleteSuccess, userMap }: IntegrationCardProps) {
  const { user, isAuthenticated, session, profile } = useAuth()
  const [isUpdating, setIsUpdating] = useState(false)
  const [favoriteState, setFavoriteState] = useState(
    integration.chatSession?.metadata?.favorite || false
  )
  const [isDeleting, setIsDeleting] = useState(false)
  const [deleteError, setDeleteError] = useState<string | null>(null)
  const router = useRouter();
  const [open, setOpen] = useState(false);
  
  // Icon ÌÉÄÏûÖÏùÑ LucideIconÏúºÎ°ú Î™ÖÏãúÏ†ÅÏúºÎ°ú ÏßÄÏ†ïÌï©ÎãàÎã§
  const Icon = integration.icon as React.ElementType
  const chatSession = integration.chatSession
  
  // ÎåÄÌôî ÏÑ∏ÏÖòÏù¥ ÏûàÏúºÎ©¥ Ìï¥Îãπ Ï†ïÎ≥¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÌÜµÌï© Ï†ïÎ≥¥ ÏÇ¨Ïö©
  const title = chatSession?.title || integration.name
  const summary = chatSession?.summary || integration.description
  const category = chatSession?.metadata?.mainCategory || integration.category
  const subCategory = chatSession?.metadata?.subCategory || ""
  const created_at = chatSession?.created_at
  const tags = (chatSession?.metadata?.tags || []) as string[]
  const messageCount = chatSession?.metadata?.messageCount || "?"
  
  // URL Íµ¨ÏÑ±
  const url = chatSession ? `/success?id=${chatSession.id}` : (integration.url || '#')
  
  // ÏÉâÏÉÅ ÏÑ§Ï†ï
  const color = categoryColors[category] || integration.color || "#64748b"
  
  // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
  const formattedDate = created_at 
    ? formatDistanceToNow(new Date(created_at), { addSuffix: true, locale: ko }) 
    : null

  // userMapÏóêÏÑú Ïù¥Î¶Ñ Ï∞æÍ∏∞
  const userName = chatSession?.user_id && userMap ? userMap[chatSession.user_id] : undefined

  // Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä Ìï∏Îì§Îü¨
  const handleFavoriteToggle = async (e: React.MouseEvent) => {
    // Ïù¥Î≤§Ìä∏ Ï†ÑÌåå ÏôÑÏ†Ñ Ï∞®Îã®
    e.preventDefault()
    e.stopPropagation()
    e.nativeEvent.stopImmediatePropagation()
    
    console.log('üîÑ Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä ÏãúÏûë:', {
      isAuthenticated,
      chatSessionId: chatSession?.id,
      chatSessionUserId: chatSession?.user_id, // ÏÑ∏ÏÖò ÏÜåÏú†Ïûê ID
      currentUserId: user?.id, // ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©Ïûê ID
      currentFavorite: favoriteState,
      isUpdating
    })
    
    // Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ ÏïåÎ¶º ÌëúÏãú
    if (!isAuthenticated) {
      alert('Ï¶êÍ≤®Ï∞æÍ∏∞ Í∏∞Îä•ÏùÄ Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.')
      return
    }
    
    if (!chatSession?.id || isUpdating) {
      console.warn('‚ùå Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä Ï°∞Í±¥ Î∂àÏ∂©Ï°±:', {
        chatSessionId: chatSession?.id,
        isUpdating
      })
      return
    }

    const newFavoriteState = !favoriteState
    setIsUpdating(true)
    
    console.log('üìù Ï¶êÍ≤®Ï∞æÍ∏∞ ÏÉÅÌÉú Î≥ÄÍ≤Ω:', {
      from: favoriteState,
      to: newFavoriteState,
      sessionId: chatSession.id,
      sessionOwnerId: chatSession.user_id,
      currentUserId: user?.id
    })
    
    // Optimistic update
    setFavoriteState(newFavoriteState)
    
    try {
      // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î•º ÏßÅÏ†ë ÏÇ¨Ïö©ÌïòÏó¨ ÏóÖÎç∞Ïù¥Ìä∏
      const supabase = getSupabaseClient()
      
      console.log('üîç Supabase ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÎèÑ:', {
        sessionId: chatSession.id,
        currentUserId: user?.id,
        newFavoriteState,
        action: newFavoriteState ? 'INSERT' : 'DELETE'
      })
      
      if (newFavoriteState) {
        // Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä
        const { data, error } = await supabase
          .from('user_favorites')
          .insert({
            user_id: user?.id,
            session_id: chatSession.id
          })
          .select('id')

        if (error) {
          console.error('‚ùå Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä ÏóêÎü¨:', {
            error,
            errorCode: error.code,
            errorMessage: error.message,
            sessionId: chatSession.id,
            userId: user?.id
          })
          throw new Error(`Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä Ïã§Ìå®: ${error.message}`)
        }
        
        console.log('‚úÖ Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä ÏÑ±Í≥µ:', {
          data,
          sessionId: chatSession.id,
          userId: user?.id
        })
      } else {
        // Ï¶êÍ≤®Ï∞æÍ∏∞ Ï†úÍ±∞
        const { data, error } = await supabase
          .from('user_favorites')
          .delete()
          .eq('user_id', user?.id)
          .eq('session_id', chatSession.id)
          .select('id')

        if (error) {
          console.error('‚ùå Ï¶êÍ≤®Ï∞æÍ∏∞ Ï†úÍ±∞ ÏóêÎü¨:', {
            error,
            errorCode: error.code,
            errorMessage: error.message,
            sessionId: chatSession.id,
            userId: user?.id
          })
          throw new Error(`Ï¶êÍ≤®Ï∞æÍ∏∞ Ï†úÍ±∞ Ïã§Ìå®: ${error.message}`)
        }
        
        console.log('‚úÖ Ï¶êÍ≤®Ï∞æÍ∏∞ Ï†úÍ±∞ ÏÑ±Í≥µ:', {
          data,
          sessionId: chatSession.id,
          userId: user?.id
        })
      }
      
      // Î∂ÄÎ™® Ïª¥Ìè¨ÎÑåÌä∏Ïóê Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏïåÎ¶º
      console.log('üîÑ Î∂ÄÎ™® Ïª¥Ìè¨ÎÑåÌä∏ ÏÉàÎ°úÍ≥†Ïπ® ÏöîÏ≤≠')
      onFavoriteToggle?.()
      
    } catch (error) {
      console.error('‚ùå Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä ÏóêÎü¨:', error)
      // Ïã§Ìå® Ïãú ÏÉÅÌÉú Î°§Î∞±
      setFavoriteState(!newFavoriteState)
    } finally {
      setIsUpdating(false)
    }
  }

  // ÏÇ≠Ï†ú Ìï∏Îì§Îü¨ Î∂ÑÎ¶¨: Ïã§Ï†ú ÏÇ≠Ï†úÎßå Îã¥Îãπ
  const doDelete = async () => {
    if (!chatSession?.id || !user?.id) return;
    if (isDeleting) return;
    setIsDeleting(true);
    setDeleteError(null);
    try {
      const res = await fetch("/api/rag/conversations", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${session?.access_token || ""}`,
        },
        body: JSON.stringify({ sessionId: chatSession.id }),
      });
      const data = await res.json();
      if (data.success) {
        setOpen(false);
        onDeleteSuccess?.(chatSession.id);
      } else {
        setDeleteError(data.error || "ÏÇ≠Ï†ú Ïã§Ìå®");
      }
    } catch (err) {
      setDeleteError("ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò");
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <>
      <Dialog open={open} onOpenChange={setOpen}>
        <Link href={url} className="block h-full">
          <Card className="hover:shadow-lg transition-all duration-300 group h-full bg-gray-800 border-gray-700 hover:border-purple-500/50 hover:transform hover:scale-[1.02] relative overflow-hidden">
            <div className="absolute inset-0 bg-gradient-to-br from-purple-600/0 via-purple-600/0 to-purple-600/0 opacity-0 group-hover:opacity-10 transition-opacity duration-300"></div>
            <CardContent className="p-4 flex flex-col h-full">
              {/* Ìó§Îçî ÏÑπÏÖò */}
              <div className="flex items-center justify-between mb-2 gap-2">
                <div className="flex items-center min-w-0">
                  <div
                    className="w-8 h-8 rounded-full flex items-center justify-center mr-2 transition-transform group-hover:scale-110 flex-shrink-0"
                    style={{ backgroundColor: `${color}20` }}
                  >
                    <Icon
                      className="w-4 h-4 transition-all group-hover:text-white"
                      style={{ color }}
                    />
                  </div>
                  <div className="truncate">
                    <span className="text-xs font-medium transition-colors truncate" style={{ color }}>
                      {category}
                      {subCategory && ` / ${subCategory}`}
                    </span>
                  </div>
                </div>
                {formattedDate && (
                  <div className="text-xs text-gray-400 flex items-center flex-shrink-0 ml-2">
                    <Clock className="w-3 h-3 mr-1" />
                    <span className="truncate max-w-[90px]">{formattedDate}</span>
                  </div>
                )}
              </div>
              
              {/* Ï†úÎ™© */}
              <h3 className="font-semibold text-sm text-white mb-2 group-hover:bg-clip-text group-hover:text-transparent group-hover:bg-gradient-to-r group-hover:from-blue-400 group-hover:via-purple-500 group-hover:to-pink-500 transition-all duration-300">
                {title}
              </h3>
              
              {/* Ïò¨Î¶∞ ÏÇ¨Îûå Ïù¥Î¶Ñ */}
              {userName && (
                <div className="text-xs text-slate-400 mb-1">ÏûëÏÑ±Ïûê: {userName}</div>
              )}
              
              {/* ÏöîÏïΩ */}
              <p className="text-xs text-gray-400 flex-grow overflow-hidden group-hover:text-gray-300 transition-colors">
                {summary.length > 150
                  ? `${summary.substring(0, 150)}...`
                  : summary}
              </p>
              
              {/* Ìë∏ÌÑ∞ */}
              <div className="mt-4 pt-3 border-t border-gray-700 flex justify-between items-center">
                {/* Ï¢åÏ∏°: ÏÇ≠Ï†ú Î≤ÑÌäº + ÌÉúÍ∑∏ */}
                <div className="flex items-center gap-2">
                  {/* ÏÇ≠Ï†ú Î≤ÑÌäº ÎÖ∏Ï∂ú Ï°∞Í±¥: Î≥∏Ïù∏ ÎåÄÌôî or Í¥ÄÎ¶¨Ïûê */}
                  {(chatSession && (chatSession.user_id === user?.id || profile?.role === 'admin')) && (
                    <button
                      onClick={e => { e.preventDefault(); e.stopPropagation(); e.nativeEvent.stopImmediatePropagation(); setOpen(true); }}
                      disabled={isDeleting}
                      className="flex items-center gap-1 p-1 text-xs rounded transition-all focus:outline-none focus:ring-2 focus:ring-red-400 disabled:opacity-60 disabled:cursor-not-allowed relative z-20 pointer-events-auto"
                      title="ÎåÄÌôî ÏÇ≠Ï†ú"
                      type="button"
                    >
                      <Trash2 className="w-4 h-4 transition-colors text-gray-400 hover:text-purple-500" />
                    </button>
                  )}
                  {/* ÌÉúÍ∑∏ (ÏûàÏùÑ Í≤ΩÏö∞) */}
                  <div className="flex flex-wrap gap-1">
                    {tags.slice(0, 2).map(tag => (
                      <span 
                        key={tag} 
                        className="text-xs bg-gray-700 px-2 py-0.5 rounded-full group-hover:bg-gray-600 transition-colors"
                      >
                        {tag}
                      </span>
                    ))}
                    {tags.length > 2 && (
                      <span className="text-xs bg-gray-700 px-2 py-0.5 rounded-full group-hover:bg-gray-600 transition-colors">
                        +{tags.length - 2}
                      </span>
                    )}
                  </div>
                </div>
                
                {/* Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ */}
                <div className="flex items-center gap-2">
                  <span className="text-xs text-gray-400 flex items-center group-hover:text-gray-300 transition-colors">
                    <MessageSquare className="w-3 h-3 mr-1" />
                    {messageCount}
                  </span>
                  {/* Ï¶êÍ≤®Ï∞æÍ∏∞ Î≤ÑÌäº - Î™®Îì† ÎåÄÌôîÏóêÏÑú ÌëúÏãú */}
                  {chatSession?.id && (
                    <button
                      onClick={handleFavoriteToggle}
                      disabled={isUpdating}
                      className={`p-1 rounded-sm transition-all duration-200 hover:scale-125 hover:bg-slate-700/50 ${
                        !isAuthenticated ? 'cursor-pointer opacity-70 hover:opacity-100' : 'cursor-pointer'
                      } ${isUpdating ? 'animate-pulse' : ''}`}
                      title={
                        !isAuthenticated 
                          ? 'Ï¶êÍ≤®Ï∞æÍ∏∞ Í∏∞Îä•ÏùÄ Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§' 
                          : (favoriteState ? 'Ï¶êÍ≤®Ï∞æÍ∏∞ Ìï¥Ï†ú' : 'Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä')
                      }
                      style={{ zIndex: 10 }}
                    >
                      <Star 
                        className={`w-4 h-4 transition-colors ${
                          !isAuthenticated
                            ? 'text-gray-500'
                            : favoriteState 
                              ? 'text-amber-400 fill-amber-400' 
                              : 'text-gray-400 hover:text-amber-400'
                        }`} 
                      />
                    </button>
                  )}
                </div>
              </div>
              {/* ÏÇ≠Ï†ú ÏóêÎü¨ Î©îÏãúÏßÄ */}
              {deleteError && (
                <div className="text-xs text-red-400 mt-1">{deleteError}</div>
              )}
            </CardContent>
          </Card>
        </Link>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌï†ÍπåÏöî?</DialogTitle>
            <DialogDescription>Ïù¥ ÎåÄÌôîÎäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button variant="secondary" onClick={() => { setOpen(false); router.push('/integrations'); }}>ÏïÑÎãàÏò§</Button>
            <Button variant="destructive" onClick={doDelete} disabled={isDeleting}>Ïòà</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  )
}
